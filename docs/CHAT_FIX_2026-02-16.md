# Chat AI Copilot Fix - February 16, 2026

## Summary

Fixed two critical bugs preventing the chat AI copilot from working:

1. **500 Error**: `saveChatMessage()` was passing invalid `rowId` parameter to `createRow()`
2. **Session Mismatch**: Block chat endpoint was saving assistant messages with wrong `chatKey`

## Bugs Fixed

### Bug 1: Invalid `rowId` Parameter (500 Error)

**Root Cause:**
- `lib/ai/chat-persistence.ts` was passing `rowId: ID.unique()` to `createRow()`
- Appwrite TablesDB v22 API auto-generates IDs and rejects this parameter
- This caused "Invalid parameter 'rowId'" error from Appwrite
- Error propagated as 500 status to client

**Fix:**
Removed the `rowId` parameter from `createRow()` call:

```typescript
// Before (WRONG)
await serverTablesDB.createRow({
  databaseId: DATABASE_ID,
  tableId: MESSAGES_TABLE_ID,
  rowId: ID.unique(), // ❌ Invalid
  data: { ... }
});

// After (CORRECT)
await serverTablesDB.createRow({
  databaseId: DATABASE_ID,
  tableId: MESSAGES_TABLE_ID,
  data: { ... }
});
```

### Bug 2: chatKey Mismatch (Messages Not Appearing)

**Root Cause:**
- Client sends `sessionKey` like `"customer_segments:1734537600000"` (with timestamp)
- User messages saved with this full sessionKey
- But assistant messages were being saved with just `blockType` (e.g., `"customer_segments"`)
- Result: User and assistant messages had different chatKey values
- When loading messages, assistant responses were orphaned and never retrieved

**Fix:**
Updated both chat endpoints to extract `chatKey` from request body and use it when saving messages:

1. **Block chat endpoint** (`/api/canvas/[canvasId]/blocks/[blockType]/chat/route.ts`):
```typescript
// Extract chatKey from request
const { messages, chatKey } = await request.json();

// Use chatKey (fallback to blockType for backwards compat)
saveChatMessage(canvasId, chatKey || blockType, user.$id, { ... })
```

2. **Canvas chat endpoint** (`/api/canvas/[canvasId]/chat/route.ts`):
```typescript
// Same fix as block chat
const { messages, chatKey } = await request.json();
saveChatMessage(canvasId, chatKey || 'general', user.$id, { ... })
```

3. **Client components** (BlockChatSection.tsx, ChatBar.tsx):
```typescript
// Pass chatKey in transport body
const transport = useMemo(
  () => new DefaultChatTransport({
    api: endpoint,
    body: { chatKey: sessionKey },
  }),
  [endpoint, sessionKey],
);
```

## Files Modified

1. `/lib/ai/chat-persistence.ts` - Removed `rowId` parameter
2. `/app/api/canvas/[canvasId]/blocks/[blockType]/chat/route.ts` - Extract and use chatKey
3. `/app/api/canvas/[canvasId]/chat/route.ts` - Extract and use chatKey
4. `/app/components/ai/BlockChatSection.tsx` - Pass chatKey to transport
5. `/app/components/ai/ChatBar.tsx` - Pass chatKey to transport

## Testing Checklist

✅ Test block chat:
- Open canvas, click block, send message
- Verify no 500 errors
- Verify assistant response appears
- Refresh page, verify messages persist

✅ Test multiple sessions:
- Create new chat session
- Send messages in different sessions
- Switch between sessions
- Verify each session shows correct messages

✅ Test canvas chat (if applicable):
- Send messages in general canvas chat
- Verify persistence and loading

✅ Verify database:
- Check messages table in Appwrite
- Confirm auto-generated $id values
- Confirm matching chatKey for user and assistant messages

## Related Documentation

- [CHAT_TROUBLESHOOTING.md](./CHAT_TROUBLESHOOTING.md) - Comprehensive troubleshooting guide
- [APPWRITE_INDEXES.md](./APPWRITE_INDEXES.md) - Required database indexes
- [APPWRITE_TABLESDB_MIGRATION.md](./APPWRITE_TABLESDB_MIGRATION.md) - TablesDB API guide
- [DATABASE_SCHEMA.md](./DATABASE_SCHEMA.md) - Complete database schema

## Key Learnings

1. **Appwrite TablesDB API**: `createRow()` auto-generates IDs - never pass `rowId`
2. **Session Management**: Always use the full sessionKey from client, not derived values
3. **Relationship Queries**: Use the related row's `$id` directly in queries
4. **Message Persistence**: chatKey must match exactly between user and assistant messages

## Backwards Compatibility

The fix includes fallback behavior:
- `chatKey || blockType` ensures old sessions without chatKey still work
- `chatKey || 'general'` ensures canvas chat works with default session

No data migration required - new messages will use correct chatKey format.
